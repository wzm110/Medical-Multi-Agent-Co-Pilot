# 医学GraphRAG数据预处理项目

## 项目概述

本项目用于将医学教材的LaTeX格式数据预处理为结构化的CSV数据块，支持GraphRAG（检索增强生成）应用。数据按照科室分类，包含完整的元数据信息。

## 文件说明

### 数据文件夹（数据/）
- **medical_chunks_v2.csv** - 主数据文件（9,817行 × 16列）
  - 包含完整的元数据和科室信息
  - UTF-8编码
  - 已修复section/subsection提取问题
  - 已改进disease_name提取逻辑
  - 新增department字段

- **科室分类CSV文件** - 按科室分离的数据
  - 呼吸内科.csv (4,066块)
  - 消化内科.csv (1,319块)
  - 心血管内科.csv (1,241块)
  - 肾内科.csv (792块)
  - 神经内科.csv (756块)
  - 急诊科.csv (592块)
  - 血液科.csv (494块)
  - 内分泌科.csv (322块)
  - 肿瘤科.csv (97块)
  - 感染科.csv (76块)
  - 风湿免疫科.csv (61块)
  - 其他科室.csv (1块)

### 程序文件
- **data_preprocessor_v2.py** - 数据预处理程序（V2版本）
  - 修复了section/subsection提取问题
  - 改进了disease_name提取逻辑
  - 新增department字段和科室映射
  - 支持三层结构（chapter/section/subsection）

- **split_data_by_department.py** - 按科室分离数据
  - 将主数据文件按department字段分离成多个CSV
  - 每个科室一个独立文件

- **analyze_data.py** - 数据分析脚本
  - 统计数据分布
  - 分析数据质量

- **triage_recommendation_demo.py** - 分诊推荐演示
  - 基于症状匹配的分诊推荐系统
  - 演示如何使用预处理的数据

### 原始数据文件夹
- **临床药物治疗学/** - 原始LaTeX教材
- **内科治疗指南/** - 原始LaTeX教材
- **内科疾病鉴别诊断学/** - 原始LaTeX教材
- **急诊内科学/** - 原始LaTeX教材
- **病理学/** - 原始LaTeX教材

## 使用方法

### 1. 运行预处理程序
```bash
cd d:\LangGraph\data
python data_preprocessor_v2.py
```
输出：medical_chunks_v2.csv

### 2. 按科室分离数据
```bash
cd d:\LangGraph\data
python split_data_by_department.py
```
输出：数据/文件夹下的各科室CSV文件

### 3. 分析数据
```bash
cd d:\LangGraph\data
python analyze_data.py
```

### 4. 运行分诊推荐演示
```bash
cd d:\LangGraph\data
python triage_recommendation_demo.py
```

## 数据统计

### 总体统计
- 总数据块数: 9,817
- 总字符数: 6,482,000
- 平均块大小: 660字符
- 有关键词的块: 100%
- 有section信息的块: 86.0%
- 有subsection信息的块: 43.0%

### 科室分类（12个）
| 科室 | 数据块数 | 占比 |
|------|---------|------|
| 呼吸内科 | 4,066 | 41.4% |
| 消化内科 | 1,319 | 13.4% |
| 心血管内科 | 1,241 | 12.6% |
| 肾内科 | 792 | 8.1% |
| 神经内科 | 756 | 7.7% |
| 急诊科 | 592 | 6.0% |
| 血液科 | 494 | 5.0% |
| 内分泌科 | 322 | 3.3% |
| 肿瘤科 | 97 | 1.0% |
| 感染科 | 76 | 0.8% |
| 风湿免疫科 | 61 | 0.6% |
| 其他科室 | 1 | 0.0% |

### 系统分类（11个）
| 系统分类 | 数据块数 | 占比 |
|---------|---------|------|
| 呼吸系统疾病 | 4,066 | 41.4% |
| 消化系统疾病 | 1,319 | 13.4% |
| 心血管系统疾病 | 1,241 | 12.6% |
| 泌尿系统疾病 | 792 | 8.1% |
| 神经系统疾病 | 756 | 7.7% |
| 急诊医学 | 592 | 6.0% |
| 血液和造血系统疾病 | 494 | 5.0% |
| 内分泌系统及代谢性疾病 | 322 | 3.3% |
| 恶性肿瘤 | 97 | 1.0% |
| 传染病 | 76 | 0.8% |
| 免疫性疾病 | 61 | 0.6% |
| 其他 | 1 | 0.0% |

### 内容类型（5种）
| 内容类型 | 数据块数 | 占比 |
|---------|---------|------|
| 鉴别诊断 | 3,655 | 37.2% |
| 急诊处理 | 3,516 | 35.8% |
| 治疗指南 | 1,023 | 10.4% |
| 药物治疗 | 895 | 9.1% |
| 病理生理 | 728 | 7.4% |

### 块类型（7种）
| 块类型 | 数据块数 | 占比 |
|-------|---------|------|
| 概述 | 3,512 | 35.8% |
| 临床表现 | 3,096 | 31.5% |
| 治疗 | 1,363 | 13.9% |
| 诊断 | 1,092 | 11.1% |
| 其他 | 676 | 6.9% |
| 预后 | 55 | 0.6% |
| 预防 | 23 | 0.2% |

## 修复内容

### 1. section和chapter相同的问题
**问题**: 原始数据中section和chapter完全相同（100%）
**原因**: 在清理LaTeX标记后才提取section，导致无法找到小节结构
**修复**: 
- 先提取LaTeX结构，再清理内容
- 实现了`_extract_sections_from_raw`和`_extract_subsections_from_raw`方法
- 现在section和chapter完全相同的比例为0%

### 2. subsection为空的问题
**问题**: 原始数据中subsection全部为空（0%有信息）
**原因**: 同样因为LaTeX标记被提前清理
**修复**: 
- 在清理LaTeX之前先提取subsection结构
- 现在有43.0%的数据块有subsection信息（4,225/9,817）

### 3. disease_name提取问题
**问题**: 只有76个唯一值，很多是系统类别而非疾病名称
**原因**: 提取逻辑不够智能，把"呼吸系统疾病"等当作疾病名称
**修复**:
- 添加了系统类别关键词过滤
- 避免把系统类别当作疾病名称
- 现在有352个唯一疾病名称

### 4. 按科室分离
**新增**: 添加了department字段
- 将系统分类映射到科室（如"呼吸系统疾病"→"呼吸内科"）
- 按科室分离数据，每个科室一个独立CSV文件
- 方便按科室进行数据处理和应用

## 元数据字段

| 字段名 | 说明 | 示例 |
|---------|------|------|
| chunk_id | 数据块唯一标识符 | chunk_000001 |
| content | 数据块内容 | 急性上呼吸道感染... |
| source_file | 来源文件路径 | 临床药物治疗学/content/chap01.tex |
| chapter | 章节名称 | 呼吸系统疾病的药物治疗 |
| section | 小节名称 | 概述 |
| subsection | 子小节名称 | 药物学和临床药物治疗学的发展简史 |
| department | 科室 | 呼吸内科 |
| system_category | 系统分类 | 呼吸系统疾病 |
| content_type | 内容类型 | 药物治疗 |
| disease_name | 疾病名称 | 急性上呼吸道感染 |
| chunk_type | 块类型 | 治疗 |
| hierarchy_level | 层级级别 | 2 |
| parent_chunk | 父块ID | （保留字段） |
| keywords | 关键词 | 发热,咳嗽,病毒,感染,药物 |
| char_count | 字符数 | 738 |
| token_count | Token数 | 369 |

## 项目结构

```
data/
├── 临床药物治疗学/           # 原始LaTeX数据
├── 内科治疗指南/             # 原始LaTeX数据
├── 内科疾病鉴别诊断学/       # 原始LaTeX数据
├── 急诊内科学/             # 原始LaTeX数据
├── 病理学/                 # 原始LaTeX数据
├── 数据/                    # 处理后的数据文件夹
│   ├── medical_chunks_v2.csv          # 主数据文件
│   ├── 呼吸内科.csv                  # 呼吸内科数据
│   ├── 消化内科.csv                  # 消化内科数据
│   ├── 心血管内科.csv                # 心血管内科数据
│   ├── 肾内科.csv                    # 肾内科数据
│   ├── 神经内科.csv                  # 神经内科数据
│   ├── 急诊科.csv                    # 急诊科数据
│   ├── 血液科.csv                    # 血液科数据
│   ├── 内分泌科.csv                  # 内分泌科数据
│   ├── 肿瘤科.csv                    # 肿瘤科数据
│   ├── 感染科.csv                    # 感染科数据
│   ├── 风湿免疫科.csv                # 风湿免疫科数据
│   └── 其他科室.csv                  # 其他科室数据
├── data_preprocessor_v2.py   # 数据预处理程序（V2）
├── split_data_by_department.py # 按科室分离数据
├── analyze_data.py          # 数据分析脚本
├── triage_recommendation_demo.py # 分诊推荐演示
├── .gitignore              # Git忽略文件
└── README.md               # 本文件
```

## 科室映射关系

| 系统分类 | 科室 |
|---------|------|
| 呼吸系统疾病 | 呼吸内科 |
| 心血管系统疾病 | 心血管内科 |
| 消化系统疾病 | 消化内科 |
| 泌尿系统疾病 | 肾内科 |
| 血液和造血系统疾病 | 血液科 |
| 神经系统疾病 | 神经内科 |
| 内分泌系统及代谢性疾病 | 内分泌科 |
| 免疫性疾病 | 风湿免疫科 |
| 恶性肿瘤 | 肿瘤科 |
| 传染病 | 感染科 |
| 急诊医学 | 急诊科 |

## 技术特点

1. **智能分块**: 保持语义完整性，平均块大小660字符
2. **三层结构**: chapter/section/subsection层级清晰
3. **关键词提取**: 使用jieba分词，自动提取关键词
4. **智能分类**: 自动识别系统分类、内容类型、块类型
5. **科室映射**: 自动将系统分类映射到科室
6. **疾病识别**: 智能提取疾病名称，过滤系统类别

## 下一步

1. 构建知识图谱
2. 优化推荐算法
3. 提高数据质量
4. 添加交互界面
5. 集成到GraphRAG系统

---
**更新日期**: 2026-01-05
**版本**: 2.0 (V2修复版)
